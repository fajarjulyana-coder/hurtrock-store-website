{% extends "admin/base.html" %}

{% block title %}Chat Analytics - Hurtrock Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-line me-2"></i>Analisis Chat Service</h2>
        <div>
            <a href="{{ url_for('admin_chat_deleted_messages') }}" class="btn btn-warning">
                <i class="fas fa-trash-restore me-2"></i>Riwayat Pesan Terhapus
            </a>
            <a href="{{ url_for('admin_chat') }}" class="btn btn-primary">
                <i class="fas fa-comments me-2"></i>Chat Interface
            </a>
        </div>
    </div>

    {% if stats.get('error') %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>{{ stats.error }}
        <br><small>Pastikan Django chat service berjalan di port 8000</small>
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Total Chat Rooms</h6>
                            <h2 class="mb-0">{{ stats.total_rooms }}</h2>
                        </div>
                        <i class="fas fa-door-open fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Rooms Aktif</h6>
                            <h2 class="mb-0">{{ stats.active_rooms }}</h2>
                        </div>
                        <i class="fas fa-comment-dots fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Total Pesan</h6>
                            <h2 class="mb-0">{{ stats.total_messages }}</h2>
                        </div>
                        <i class="fas fa-envelope fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Pesan Belum Dibaca</h6>
                            <h2 class="mb-0">{{ stats.unread_messages }}</h2>
                        </div>
                        <i class="fas fa-bell fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Response Time -->
    {% if stats.avg_response_time %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-clock me-2"></i>Rata-rata Waktu Respon</h5>
                    <h3 class="text-primary">{{ "%.1f"|format(stats.avg_response_time) }} detik</h3>
                    <div class="progress" style="height: 25px;">
                        {% set response_pct = (stats.avg_response_time / 60 * 100)|int if stats.avg_response_time < 60 else 100 %}
                        <div class="progress-bar {% if response_pct < 30 %}bg-success{% elif response_pct < 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                             role="progressbar" style="width: {{ response_pct }}%">
                            {{ "%.1f"|format(stats.avg_response_time) }}s
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        <i class="fas fa-info-circle"></i> Target: < 30 detik (baik), 30-60 detik (cukup), > 60 detik (perlu ditingkatkan)
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Chat Activity -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Aktivitas Chat Terbaru</h5>
        </div>
        <div class="card-body">
            {% if recent_chats %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID Room</th>
                            <th>Customer</th>
                            <th>Status</th>
                            <th>Pesan Terakhir</th>
                            <th>Waktu</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for chat in recent_chats %}
                        <tr>
                            <td><code>{{ chat.room_id or 'N/A' }}</code></td>
                            <td>
                                <i class="fas fa-user me-1"></i>
                                {{ chat.customer_name or 'Guest' }}
                            </td>
                            <td>
                                {% if chat.is_active %}
                                <span class="badge bg-success">Aktif</span>
                                {% else %}
                                <span class="badge bg-secondary">Selesai</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ (chat.last_message or 'Tidak ada pesan')[:50] }}...</small>
                            </td>
                            <td>
                                <small>{{ chat.last_activity or 'N/A' }}</small>
                            </td>
                            <td>
                                <a href="{{ url_for('admin_chat') }}#room-{{ chat.room_id }}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5 text-muted">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>Belum ada aktivitas chat</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Help Section -->
    <div class="card mt-4 border-info">
        <div class="card-header bg-info text-white">
            <i class="fas fa-info-circle me-2"></i>Informasi
        </div>
        <div class="card-body">
            <h6>Cara Menggunakan Chat Analytics:</h6>
            <ul>
                <li><strong>Total Chat Rooms:</strong> Jumlah keseluruhan ruang chat yang pernah dibuat</li>
                <li><strong>Rooms Aktif:</strong> Ruang chat yang masih dalam proses komunikasi</li>
                <li><strong>Total Pesan:</strong> Jumlah keseluruhan pesan yang terkirim</li>
                <li><strong>Pesan Belum Dibaca:</strong> Pesan dari customer yang belum dibaca oleh admin/staff</li>
                <li><strong>Riwayat Pesan Terhapus:</strong> Untuk melihat pesan yang sudah dihapus (fraud prevention)</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}
