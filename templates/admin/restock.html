
{% extends "admin/base.html" %}

{% block title %}Kelola Restock - Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <svg class="admin-svg-icon me-2 text-orange" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14.5 2H6C5.5 2 5 2.5 5 3V21C5 21.5 5.5 22 6 22H18C18.5 22 19 21.5 19 21V7.5L14.5 2Z" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>Kelola Restock Orders
    </h2>
    <button class="btn btn-orange" data-bs-toggle="modal" data-bs-target="#createRestockModal">
        <svg class="admin-svg-icon me-2" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M12 8V16M8 12H16" stroke="currentColor" stroke-width="2"/>
        </svg>Buat Restock Order
    </button>
</div>

<!-- Restock Orders Table -->
<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Order ID</th>
                        <th>Supplier</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th>Tanggal Order</th>
                        <th>Expected Date</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in restock_orders %}
                    <tr>
                        <td><strong>RST-{{ "%05d"|format(order.id) }}</strong></td>
                        <td>
                            <strong>{{ order.supplier.name }}</strong>
                            {% if order.supplier.contact_person %}
                                <br><small class="text-muted">{{ order.supplier.contact_person }}</small>
                            {% endif %}
                        </td>
                        <td>{{ order.formatted_total }}</td>
                        <td>
                            {% if order.status == 'pending' %}
                                <span class="badge bg-warning">Pending</span>
                            {% elif order.status == 'ordered' %}
                                <span class="badge bg-info">Ordered</span>
                            {% elif order.status == 'received' %}
                                <span class="badge bg-success">Received</span>
                            {% elif order.status == 'cancelled' %}
                                <span class="badge bg-danger">Cancelled</span>
                            {% endif %}
                        </td>
                        <td>{{ order.created_at.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {% if order.expected_date %}
                                {{ order.expected_date.strftime('%d/%m/%Y') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="viewRestockOrder({{ order.id }})" data-bs-toggle="modal" data-bs-target="#viewRestockModal">
                                    <svg class="admin-svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                                        <path d="M12 1C18 1 22 7 22 12S18 23 12 23 2 17 2 12 6 1 12 1Z" stroke="currentColor" stroke-width="2" fill="none"/>
                                    </svg>
                                </button>
                                <button class="btn btn-outline-primary" onclick="updateStatus({{ order.id }})" data-bs-toggle="modal" data-bs-target="#updateStatusModal">
                                    <svg class="admin-svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M11 4H4C3.4 4 3 4.4 3 5V20C3 20.6 3.4 21 4 21H19C19.6 21 20 20.6 20 20V13" stroke="currentColor" stroke-width="2" fill="none"/>
                                        <path d="M18.5 2.5C19.3 1.7 20.7 1.7 21.5 2.5S22.3 4.7 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" fill="none"/>
                                    </svg>
                                </button>
                                <a href="{{ url_for('admin_generate_restock_invoice', order_id=order.id) }}" class="btn btn-outline-secondary">
                                    <svg class="admin-svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9V2C6 1.4 6.4 1 7 1H13L17 5V9" stroke="currentColor" stroke-width="2" fill="none"/>
                                        <rect x="6" y="9" width="12" height="13" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                                        <circle cx="8" cy="13" r="2" stroke="currentColor" stroke-width="2" fill="none"/>
                                        <path d="M8 21V15M12 17L15 14" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Restock Order Modal -->
<div class="modal fade" id="createRestockModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Buat Restock Order Baru</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_create_restock_order') }}" id="createRestockForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Supplier *</label>
                                <select class="form-select" name="supplier_id" required>
                                    <option value="">Pilih Supplier</option>
                                    {% for supplier in suppliers %}
                                        <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Expected Date</label>
                                <input type="date" class="form-control" name="expected_date">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Catatan</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                    
                    <h6 class="mt-4 mb-3">Items</h6>
                    
                    <!-- Search Product Section -->
                    <div class="mb-3">
                        <label class="form-label">Cari Produk *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="productSearchInput" class="form-control" placeholder="Cari berdasarkan ID, GTIN, Nama, Brand, atau Kategori..." disabled>
                        </div>
                        <small class="text-muted">Pilih supplier terlebih dahulu untuk mencari produk</small>
                        <div id="productSearchResults" class="list-group mt-2" style="max-height: 300px; overflow-y: auto; display: none;"></div>
                    </div>
                    
                    <div id="restock-items">
                        <!-- Item rows will be added here dynamically -->
                    </div>
                    
                    <div id="no-items-message" class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Gunakan pencarian di atas untuk menambahkan produk ke restock order
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addRestockItem()">
                        <svg class="admin-svg-icon me-1" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M12 8V16M8 12H16" stroke="currentColor" stroke-width="2"/>
                        </svg>Tambah Item
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-orange">Buat Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Status Restock Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateStatusForm" method="POST">
                {{ csrf_token() }}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Status *</label>
                        <select class="form-select" name="status" required>
                            <option value="pending">Pending</option>
                            <option value="ordered">Ordered</option>
                            <option value="received">Received</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-orange">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Restock Order Modal -->
<div class="modal fade" id="viewRestockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detail Restock Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewRestockContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
const restockOrders = {{ restock_orders_data | tojson }};
const allProducts = {{ products_data | tojson }};
let currentSupplierProducts = [];
let searchTimeout;
let addedProductIds = new Set();

// Enable product search when supplier is selected
document.querySelector('select[name="supplier_id"]').addEventListener('change', function() {
    const supplierId = this.value;
    const searchInput = document.getElementById('productSearchInput');
    
    if (supplierId) {
        // Filter products by supplier
        currentSupplierProducts = allProducts.filter(p => p.supplier_id == supplierId);
        
        searchInput.disabled = false;
        searchInput.placeholder = `Cari dari ${currentSupplierProducts.length} produk supplier ini...`;
        
        if (currentSupplierProducts.length === 0) {
            searchInput.disabled = true;
            searchInput.placeholder = 'Supplier ini belum memiliki produk';
            showAlert('warning', 'Supplier ini belum memiliki produk terdaftar.');
        }
    } else {
        currentSupplierProducts = [];
        searchInput.disabled = true;
        searchInput.placeholder = 'Pilih supplier terlebih dahulu untuk mencari produk';
        document.getElementById('productSearchResults').style.display = 'none';
    }
    
    // Clear search
    searchInput.value = '';
});

// Real-time product search
document.getElementById('productSearchInput').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    const query = e.target.value.toLowerCase().trim();
    
    searchTimeout = setTimeout(() => {
        searchProducts(query);
    }, 300); // 300ms debounce
});

function searchProducts(query) {
    const resultsContainer = document.getElementById('productSearchResults');
    
    if (!query || query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    // Filter products by search query
    const filteredProducts = currentSupplierProducts.filter(product => {
        const searchText = `${product.id} ${product.gtin || ''} ${product.name} ${product.brand || ''} ${product.category_name || ''}`.toLowerCase();
        return searchText.includes(query);
    });
    
    // Display results
    if (filteredProducts.length === 0) {
        resultsContainer.innerHTML = `
            <div class="list-group-item text-center text-muted">
                <i class="fas fa-search fa-2x mb-2"></i>
                <p class="mb-0">Tidak ada produk ditemukan</p>
            </div>
        `;
        resultsContainer.style.display = 'block';
    } else {
        resultsContainer.innerHTML = filteredProducts.map(product => {
            const isAdded = addedProductIds.has(product.id);
            const stockStatus = product.stock_quantity <= 0 ? 'text-danger' : 
                               product.stock_quantity <= product.minimum_stock ? 'text-warning' : 'text-success';
            
            return `
                <a href="#" class="list-group-item list-group-item-action ${isAdded ? 'disabled bg-light' : ''}" 
                   onclick="addProductToRestock(${product.id}); return false;">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${product.name}</h6>
                            <small class="text-muted">
                                ID: ${product.id} ${product.gtin ? `| GTIN: ${product.gtin}` : ''} 
                                ${product.brand ? `| Brand: ${product.brand}` : ''}
                                ${product.category_name ? `| ${product.category_name}` : ''}
                            </small>
                        </div>
                        <div class="text-end ms-3">
                            <span class="badge ${stockStatus === 'text-danger' ? 'bg-danger' : stockStatus === 'text-warning' ? 'bg-warning' : 'bg-success'}">
                                Stock: ${product.stock_quantity}
                            </span>
                            ${isAdded ? '<br><small class="text-muted">Sudah ditambahkan</small>' : ''}
                        </div>
                    </div>
                </a>
            `;
        }).join('');
        resultsContainer.style.display = 'block';
    }
}

function addProductToRestock(productId) {
    // Check if already added
    if (addedProductIds.has(productId)) {
        showAlert('warning', 'Produk ini sudah ditambahkan!');
        return;
    }
    
    const product = currentSupplierProducts.find(p => p.id === productId);
    if (!product) return;
    
    const container = document.getElementById('restock-items');
    const noItemsMsg = document.getElementById('no-items-message');
    
    // Hide no items message
    if (noItemsMsg) {
        noItemsMsg.style.display = 'none';
    }
    
    // Create new row
    const newRow = document.createElement('div');
    newRow.className = 'row restock-item-row mt-2 align-items-center';
    newRow.dataset.productId = productId;
    
    const stockStatus = product.stock_quantity <= 0 ? 'Habis' : 
                       product.stock_quantity <= product.minimum_stock ? 'Kritis' : 
                       product.stock_quantity <= product.low_stock_threshold ? 'Rendah' : 'Normal';
    
    newRow.innerHTML = `
        <div class="col-md-5">
            <input type="hidden" name="product_ids[]" value="${productId}">
            <div class="border rounded p-2 bg-light">
                <strong>${product.name}</strong><br>
                <small class="text-muted">
                    Stock: ${product.stock_quantity} (${stockStatus})
                    ${product.brand ? `| ${product.brand}` : ''}
                </small>
            </div>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" name="quantities[]" placeholder="Qty" min="1" required value="1">
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="unit_costs[]" placeholder="Harga Satuan" min="0" step="1000" required>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRestockItem(this, ${productId})">
                <i class="fas fa-trash"></i> Hapus
            </button>
        </div>
    `;
    
    container.appendChild(newRow);
    addedProductIds.add(productId);
    
    // Clear search
    document.getElementById('productSearchInput').value = '';
    document.getElementById('productSearchResults').style.display = 'none';
    
    showAlert('success', `${product.name} berhasil ditambahkan!`);
}

function removeRestockItem(button, productId) {
    const row = button.closest('.restock-item-row');
    row.remove();
    addedProductIds.delete(productId);
    
    const container = document.getElementById('restock-items');
    const noItemsMsg = document.getElementById('no-items-message');
    
    // Show no items message if empty
    if (container.children.length === 0 && noItemsMsg) {
        noItemsMsg.style.display = 'block';
    }
    
    showAlert('info', 'Item dihapus dari restock order');
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

function updateStatus(orderId) {
    const order = restockOrders.find(o => o.id === orderId);
    if (order) {
        document.querySelector('#updateStatusForm select[name="status"]').value = order.status;
        document.getElementById('updateStatusForm').action = `{{ url_for('admin_update_restock_status', order_id=0) }}`.replace('0', orderId);
    }
}

function viewRestockOrder(orderId) {
    const order = restockOrders.find(o => o.id === orderId);
    if (order) {
        let itemsHtml = '';
        if (order.items && order.items.length > 0) {
            itemsHtml = order.items.map(item => `
                <tr>
                    <td>${item.product.name}</td>
                    <td>${item.quantity_ordered}</td>
                    <td>Rp ${item.unit_cost.toLocaleString('id-ID')}</td>
                    <td>Rp ${(item.quantity_ordered * item.unit_cost).toLocaleString('id-ID')}</td>
                </tr>
            `).join('');
        }
        
        const content = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Order Information</h6>
                    <p><strong>Order ID:</strong> RST-${order.id.toString().padStart(5, '0')}</p>
                    <p><strong>Supplier:</strong> ${order.supplier.name}</p>
                    <p><strong>Status:</strong> ${order.status}</p>
                    <p><strong>Total Amount:</strong> ${order.formatted_total}</p>
                </div>
                <div class="col-md-6">
                    <h6>Dates</h6>
                    <p><strong>Created:</strong> ${new Date(order.created_at).toLocaleDateString('id-ID')}</p>
                    <p><strong>Expected:</strong> ${order.expected_date ? new Date(order.expected_date).toLocaleDateString('id-ID') : '-'}</p>
                    <p><strong>Received:</strong> ${order.received_date ? new Date(order.received_date).toLocaleDateString('id-ID') : '-'}</p>
                </div>
            </div>
            ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
            <h6 class="mt-3">Items</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Unit Cost</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml || '<tr><td colspan="4" class="text-center">No items found</td></tr>'}
                    </tbody>
                </table>
            </div>
        `;
        
        document.getElementById('viewRestockContent').innerHTML = content;
    }
}
</script>
{% endblock %}
